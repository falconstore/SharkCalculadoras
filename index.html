<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora Surebet — Shark</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8" style="background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 25%, #16213e 50%, #0f3460 100%);">
  <div class="max-w-6xl mx-auto">
    <div id="app"></div>
  </div>

<script>
(() => {
  // ===== Utils =====
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function parseFlex(n) {
    if (n === null || n === undefined) return NaN;
    const s = String(n).trim();
    if (s === '') return NaN;
    const hasComma = s.includes(',');
    const hasDot = s.includes('.');
    let t = s;
    if (hasComma && !hasDot) t = s.replace(',', '.');            // 1,23 -> 1.23
    else if (hasComma && hasDot) t = s.replace(/\./g,'').replace(',', '.'); // 1.234,56 -> 1234.56
    const v = parseFloat(t);
    return Number.isFinite(v) ? v : NaN;
  }
  const toFixed2 = (n) => (Number.isFinite(n) ? n.toFixed(2) : "0.00");
  const fmtBRL = (n) => (Number.isFinite(n) ? n : 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  const fmtDec = (n) => Number.isFinite(n) ? n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "";
  const keepNumeric = (s) => s.replace(/[^0-9.,]/g, "");

  const MAX_HOUSES = 6;
  let numHouses = 2;
  let roundingValue = 0.01;
  let displayRounding = "0.01";
  let manualOverrides = {};

  let houses = Array.from({ length: MAX_HOUSES }).map((_, index) => ({
    odd: "",
    increase: "",
    finalOdd: 0,
    stake: "0",
    commission: null,
    freebet: false,
    fixedStake: index === 0,
    lay: false,
    responsibility: ""
  }));

  let results = { profits: [], totalStake: 0, roi: 0 };

  const roundStake = (value) => {
    const num = parseFlex(value);
    if (!Number.isFinite(num)) return value;
    const rounded = Math.round(num / roundingValue) * roundingValue;
    return fmtDec(rounded);
  };
  const activeHouses = () => houses.slice(0, numHouses);

  // ===== UI Sync helpers (sem re-render geral) =====
  function setInputValue(id, value) {
    const el = document.getElementById(id);
    if (el && el.value !== value) el.value = value;
  }
  function updateHouseUI(idx) {
    const h = houses[idx];
    // Odd Final
    const oddEl = document.getElementById(`finalOdd-${idx}`);
    if (oddEl) oddEl.textContent = toFixed2(h.finalOdd || 0).replace('.', ',');
    // Stake (apenas quando NÃO é override manual)
    if (!(manualOverrides[idx] && manualOverrides[idx].stake)) {
      setInputValue(`stake-${idx}`, h.stake || "");
    }
    // Responsabilidade (quando LAY e sem override)
    if (h.lay && !(manualOverrides[idx] && manualOverrides[idx].responsibility)) {
      setInputValue(`responsibility-${idx}`, h.responsibility || "");
    }
    // Odd text não mexemos enquanto o usuário digita
  }
  function updateAllHouseUIs() {
    activeHouses().forEach((_, i) => updateHouseUI(i));
  }

  function updateResultsUI() {
    // Topo
    $("#totalStake").textContent = fmtBRL(results.totalStake);
    const roiEl = $("#roi");
    roiEl.textContent = (results.roi >= 0 ? "+" : "") + results.roi.toFixed(2) + "%";
    roiEl.className = "text-lg font-bold font-mono " + (results.roi >= 0 ? "text-green-400" : "text-red-400");

    // Resultados
    const active = activeHouses();
    const anyLay = active.some(h => h.lay);
    const headerCols = anyLay ? "grid-cols-5 gap-3" : "grid-cols-4 gap-3";
    const header = `
      <div class="grid text-cyan-100 p-3 border-b border-cyan-500/20 font-bold text-xs whitespace-nowrap min-w-max uppercase tracking-wider ${headerCols}">
        <div class="min-w-16 text-center">CASA</div>
        <div class="min-w-16 text-center">ODD</div>
        <div class="min-w-20 text-center">STAKE</div>
        ${anyLay ? '<div class="min-w-24 text-center">RESP.</div>' : ''}
        <div class="min-w-20 text-center">LUCRO</div>
      </div>
    `;
    $("#resultsHeader").outerHTML = header.replace('<div class="grid', '<div id="resultsHeader" class="grid');

    const rowsHTML = active.map((h, idx) => {
      const oddText = h.freebet ? toFixed2(parseFlex(h.odd) || 0).replace('.', ',')
                                : toFixed2(h.finalOdd || 0).replace('.', ',');
      const stakeText = h.stake ? h.stake : "0,00";
      const profit = results.profits[idx] || 0;
      const profitPos = profit >= 0;
      return `
        <div class="grid p-3 border-b border-cyan-500/10 text-xs whitespace-nowrap min-w-max hover:bg-cyan-500/5 transition-colors duration-200 ${headerCols}">
          <div class="text-cyan-200 min-w-16 text-center font-medium">Casa ${idx + 1}</div>
          <div class="text-cyan-100 min-w-16 text-center font-mono">${oddText}</div>
          <div class="text-cyan-100 min-w-20 text-center font-mono flex items-center justify-center gap-1">R$ ${stakeText}${h.freebet ? '<span class="text-yellow-400 text-[10px]">(Freebet)</span>' : ''}</div>
          ${anyLay ? `<div class="text-cyan-100 min-w-24 text-center font-mono">${h.lay ? fmtBRL(parseFlex(h.responsibility)||0) : '-'}</div>` : ''}
          <div class="min-w-20 text-center font-mono font-bold ${profitPos ? 'text-green-400' : 'text-red-400'}">${profitPos ? '' : '-'}${fmtBRL(Math.abs(profit))}</div>
        </div>
      `;
    }).join("");
    $("#resultsRows").innerHTML = rowsHTML;
  }

  function recalcAndUpdate(syncCards=true) {
    calculateResults(activeHouses());
    if (syncCards) updateAllHouseUIs();
    updateResultsUI();
  }

  // ===== Cálculo =====
  function calculateResults(active) {
    let totalStake = 0;
    let totalFreebetValue = 0;
    const profits = new Array(active.length).fill(0);

    active.forEach(h => {
      const stake = parseFlex(h.stake) || 0;
      const resp = parseFlex(h.responsibility) || 0;
      if (h.freebet) totalFreebetValue += stake; else totalStake += h.lay ? resp : stake;
    });

    active.forEach((h, idx) => {
      const stake = parseFlex(h.stake) || 0;
      const odd = h.finalOdd || 0;
      const commission = h.commission || 0;

      if (h.lay) {
        const resp = parseFlex(h.responsibility) || 0;
        const profit = stake * (1 - commission / 100) - (totalStake - resp);
        profits[idx] = profit;
      } else if (h.freebet) {
        const grossProfit = stake * odd - totalStake;
        const comm = grossProfit > 0 ? (commission / 100) * grossProfit : 0;
        profits[idx] = grossProfit - comm;
      } else {
        const effectiveOdd = odd * (1 - commission / 100);
        const grossProfit = stake * effectiveOdd - totalStake;
        profits[idx] = grossProfit;
      }
    });

    const minProfit = profits.length ? Math.min(...profits) : 0;
    const roi = (active.some(h => h.freebet) ? (minProfit / (active.reduce((s,h)=>s+(h.freebet?parseFlex(h.stake)||0:0),0)||1))*100
                                            : (totalStake>0?(minProfit/totalStake)*100:0));
    results = { profits, totalStake, roi };
  }

  // ===== State Ops =====
  function setHouse(idx, patch, setOverrideKeys = []) {
    const prev = houses[idx];
    const h = { ...prev, ...patch };

    const oddVal = parseFlex(h.odd) || 0;
    const incVal = parseFlex(h.increase) || 0;
    h.finalOdd = h.freebet ? Math.max(oddVal - 1, 0) : oddVal * (1 + incVal / 100);

    // Se LAY e sem override manual, calcula responsabilidade = stake*(odd-1)
    if (h.lay && !(manualOverrides[idx] && manualOverrides[idx].responsibility)) {
      const stakeVal = parseFlex(h.stake) || 0;
      if (stakeVal > 0 && oddVal > 1) h.responsibility = fmtDec(stakeVal * (oddVal - 1));
      else if (!h.responsibility) h.responsibility = "";
    }

    houses[idx] = h;

    if (setOverrideKeys.length) {
      manualOverrides[idx] = manualOverrides[idx] || {};
      setOverrideKeys.forEach(k => manualOverrides[idx][k] = true);
    }

    updateHouseUI(idx);
    recalcStakeDistribution(idx); // << novo: ajusta outras casas quando necessário
    recalcAndUpdate(false);       // recalcula e atualiza resultados, sem reescrever inputs já sincronizados
  }

  function recalcStakeDistribution(sourceIdx) {
    const active = activeHouses();
    const fixedIndex = active.findIndex(h => h.fixedStake);
    if (fixedIndex === -1) return;

    const fixed = active[fixedIndex];
    const fixedStake = parseFlex(fixed.stake) || 0;
    const fixedOdd = fixed.finalOdd;
    if (!(fixedStake > 0 && fixedOdd > 0)) return;

    let changed = false;
    const newHouses = [...houses];

    active.forEach((h, idx) => {
      const overrides = manualOverrides[idx] || {};
      const oddVal = parseFlex(h.odd) || 0;
      const stakeVal = parseFlex(h.stake) || 0;

      // Atualiza responsabilidade lay automática
      if (h.lay && !overrides.responsibility && oddVal > 1 && stakeVal > 0) {
        const responsibility = stakeVal * (oddVal - 1);
        const current = parseFlex(h.responsibility) || 0;
        if (Math.abs(current - responsibility) > 0.005) {
          changed = true;
          newHouses[idx] = { ...newHouses[idx], responsibility: fmtDec(responsibility) };
        }
      }

      // Recalcula stakes das casas não-fixas sem override
      if (idx !== fixedIndex && h.finalOdd > 0 && !overrides.stake) {
        const fixedCommission = fixed.commission || 0;
        const houseCommission = h.commission || 0;
        const fixedProfit = fixedStake * fixedOdd * (1 - fixedCommission / 100);

        let calcStake;
        if (h.lay) {
          calcStake = fixedProfit / (h.finalOdd - houseCommission / 100);
        } else {
          const effectiveOdd = h.finalOdd * (1 - houseCommission / 100);
          calcStake = fixedProfit / effectiveOdd;
        }

        let finalStake;
        if (h.lay) finalStake = fmtDec(calcStake);
        else finalStake = roundStake(calcStake);

        const currentStake = parseFlex(h.stake) || 0;
        const finalStakeNum = parseFlex(finalStake) || 0;
        if (Math.abs(currentStake - finalStakeNum) > 0.005) {
          changed = true;
          if (h.lay) {
            const resp = finalStakeNum * Math.max(oddVal - 1, 0);
            newHouses[idx] = { ...newHouses[idx], stake: finalStake, responsibility: fmtDec(resp), fixedStake: false };
          } else {
            newHouses[idx] = { ...newHouses[idx], stake: finalStake, fixedStake: false };
          }
        }
      }
    });

    if (changed) {
      houses = newHouses;
      updateAllHouseUIs();
    }
  }

  function fixStake(idx) {
    houses = houses.map((h, i) => ({ ...h, fixedStake: i === idx ? !h.fixedStake : false }));
    recalcStakeDistribution(idx);
    recalcAndUpdate();
  }

  // ===== Render inicial =====
  function HouseCard(idx, h) {
    const oddDisplay = toFixed2(h.finalOdd || 0).replace('.', ',');
    const stakeVal = h.stake || "";
    const respVal = h.lay ? (h.responsibility || "") : "";

    return `
      <div class="bg-gray-900/40 backdrop-blur-md rounded-xl p-3 border border-cyan-500/20 shadow-lg shadow-cyan-500/10 hover:shadow-cyan-500/15 hover:border-cyan-400/30 transition-all duration-300 h-full">
        <h3 class="text-cyan-400 text-sm mb-2 font-bold uppercase tracking-wider text-center">Casa ${idx + 1}</h3>
        <div class="space-y-2">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-cyan-200 mb-1 block text-xs" for="odd-${idx}">Odd</label>
              <input id="odd-${idx}" data-action="odd" data-idx="${idx}" type="text" inputmode="decimal" value="${h.odd}"
                class="flex h-8 w-full rounded-lg bg-gray-900/50 border border-cyan-500/30 text-cyan-100 px-3 text-xs shadow-lg backdrop-blur-sm transition-all duration-200 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 focus:outline-none hover:border-cyan-400/50 placeholder:text-cyan-300/50" />
            </div>
            <div>
              <label class="text-cyan-200 mb-1 block text-xs">Odd Final</label>
              <div id="finalOdd-${idx}" class="h-8 flex items-center px-3 bg-gray-800/60 border border-cyan-500/20 rounded-lg text-xs text-cyan-100 font-mono">${oddDisplay}</div>
            </div>
          </div>

          ${h.lay ? `
          <div>
            <label class="text-cyan-200 mb-1 block text-xs" for="responsibility-${idx}">Responsabilidade</label>
            <div class="relative">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-cyan-300 text-xs font-bold">R$</span>
              <input id="responsibility-${idx}" data-action="responsibility" data-idx="${idx}" type="text" inputmode="decimal" value="${respVal}"
                class="pl-10 flex h-8 w-full rounded-lg bg-gray-900/50 border border-cyan-500/30 text-cyan-100 px-3 text-xs shadow-lg backdrop-blur-sm transition-all duration-200 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 focus:outline-none hover:border-cyan-400/50 placeholder:text-cyan-300/50 font-mono" />
            </div>
          </div>` : ``}

          <div>
            <label class="text-cyan-200 mb-1 block text-xs" for="stake-${idx}">Stake</label>
            <div class="flex gap-2">
              <div class="relative flex-1">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-cyan-300 text-xs font-bold">R$</span>
                <input id="stake-${idx}" data-action="stake" data-idx="${idx}" type="text" inputmode="decimal" value="${stakeVal}"
                  class="pl-10 flex h-8 w-full rounded-lg bg-gray-900/50 border border-cyan-500/30 text-cyan-100 px-3 text-xs shadow-lg backdrop-blur-sm transition-all duration-200 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 focus:outline-none hover:border-cyan-400/50 placeholder:text-cyan-300/50 font-mono" />
              </div>
              <button data-action="toggleLay" data-idx="${idx}"
                class="${h.lay ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-gradient-to-r from-cyan-500 to-blue-500'} text-white shadow-lg ${h.lay ? 'shadow-purple-500/25' : 'shadow-cyan-500/25'} hover:shadow-cyan-500/40 hover:scale-105 active:scale-95 inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-lg text-xs font-black h-8 px-3 uppercase tracking-wider">
                ${h.lay ? 'L' : 'B'}
              </button>
            </div>
          </div>

          <div class="flex flex-wrap gap-3">
            <label class="flex items-center space-x-2 text-cyan-200 text-xs normal-case cursor-pointer select-none">
              <input type="checkbox" ${h.commission !== null ? 'checked' : ''} data-action="toggleCommission" data-idx="${idx}"
                class="h-5 w-5 rounded border-2 border-cyan-400/50 bg-gray-900/50 text-cyan-400 shadow-lg focus:ring-2 focus:ring-cyan-400/30 focus:ring-offset-0 transition-all duration-200 cursor-pointer accent-cyan-400" />
              <span>Comissão</span>
            </label>
            <label class="flex items-center space-x-2 text-cyan-200 text-xs normal-case cursor-pointer select-none">
              <input type="checkbox" ${h.freebet ? 'checked' : ''} data-action="toggleFreebet" data-idx="${idx}"
                class="h-5 w-5 rounded border-2 border-cyan-400/50 bg-gray-900/50 text-cyan-400 shadow-lg focus:ring-2 focus:ring-cyan-400/30 focus:ring-offset-0 transition-all duration-200 cursor-pointer accent-cyan-400" />
              <span>Freebet</span>
            </label>
          </div>

          ${h.commission !== null ? `
          <div>
            <label class="text-cyan-200 text-xs mb-1 block" for="commission-${idx}">Comissão (%)</label>
            <div class="relative">
              <input id="commission-${idx}" data-action="commissionValue" data-idx="${idx}" type="text" inputmode="decimal" value="${h.commission === 0 ? '' : (h.commission ?? '')}"
                class="flex h-8 w-full rounded-lg bg-gray-900/50 border border-cyan-500/30 text-cyan-100 px-3 text-xs shadow-lg backdrop-blur-sm transition-all duration-200 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 focus:outline-none hover:border-cyan-400/50 placeholder:text-cyan-300/50 font-mono pr-10" />
              <span class="absolute right-3 top-1/2 -translate-y-1/2 text-cyan-300 text-xs font-bold">%</span>
            </div>
          </div>` : ``}

          <button data-action="fixStake" data-idx="${idx}"
            class="w-full h-8 text-xs font-bold uppercase tracking-wider rounded-lg ${h.fixedStake ? 'bg-gradient-to-r from-green-500 to-emerald-500 shadow-green-500/25' : 'bg-gradient-to-r from-gray-600 to-gray-700 shadow-gray-600/25'}">
            ${h.fixedStake ? 'Stake Fixa' : 'Fixar Stake'}
          </button>
        </div>
      </div>
    `;
  }

  function renderHouses() {
    const list = activeHouses().map((h, idx) => HouseCard(idx, h)).join("");
    return `<div id="houses" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4">${list}</div>`;
  }

  function renderTop() {
    return `
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
        <div class="bg-gray-900/40 backdrop-blur-md rounded-xl p-3 border border-cyan-500/20 shadow-lg shadow-cyan-500/10">
          <h2 class="text-cyan-400 text-sm mb-2 font-bold uppercase tracking-wider text-center">Configurações</h2>
          <label class="text-cyan-200 mb-1 block text-xs">Número de Casas:</label>
          <select id="numHouses" class="flex h-8 w-full rounded-lg bg-gray-900/50 border border-cyan-500/30 text-cyan-100 px-3 text-xs shadow-lg backdrop-blur-sm transition-all duration-200 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 focus:outline-none hover:border-cyan-400/50">
            <option value="2" ${numHouses===2?'selected':''}>2 Casas</option>
            <option value="3" ${numHouses===3?'selected':''}>3 Casas</option>
            <option value="4" ${numHouses===4?'selected':''}>4 Casas</option>
            <option value="5" ${numHouses===5?'selected':''}>5 Casas</option>
          </select>
        </div>

        <div class="bg-gray-900/40 backdrop-blur-md rounded-xl p-3 border border-cyan-500/20 shadow-lg shadow-cyan-500/10">
          <h2 class="text-cyan-400 text-sm mb-2 font-bold uppercase tracking-wider text-center">Arredondamento</h2>
          <label class="text-cyan-200 mb-1 block text-xs">Stakes Para:</label>
          <select id="rounding" class="flex h-8 w-full rounded-lg bg-gray-900/50 border border-cyan-500/30 text-cyan-100 px-3 text-xs shadow-lg backdrop-blur-sm transition-all duration-200 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 focus:outline-none hover:border-cyan-400/50">
            <option value="0.01" ${displayRounding==="0.01"?'selected':''}>R$ 0,01</option>
            <option value="0.10" ${displayRounding==="0.10"?'selected':''}>R$ 0,10</option>
            <option value="0.50" ${displayRounding==="0.50"?'selected':''}>R$ 0,50</option>
            <option value="1.00" ${displayRounding==="1.00"?'selected':''}>R$ 1,00</option>
          </select>
        </div>

        <div class="bg-gray-900/40 backdrop-blur-md rounded-xl p-3 border border-cyan-500/20 shadow-lg shadow-cyan-500/10 text-center">
          <h2 class="text-cyan-400 text-sm mb-2 font-bold uppercase tracking-wider">Total Investido</h2>
          <div id="totalStake" class="text-lg text-cyan-100 font-bold font-mono">R$ 0,00</div>
        </div>

        <div class="bg-gray-900/40 backdrop-blur-md rounded-xl p-3 border border-cyan-500/20 shadow-lg shadow-cyan-500/10 text-center">
          <h2 class="text-cyan-400 text-sm mb-2 font-bold uppercase tracking-wider">ROI Médio</h2>
          <div id="roi" class="text-lg font-bold font-mono text-green-400">0,00%</div>
        </div>
      </div>
    `;
  }

  function renderResultsShell() {
    return `
      <div class="bg-gray-900/40 backdrop-blur-md rounded-xl p-4 border border-cyan-500/20 shadow-lg shadow-cyan-500/10 mt-4">
        <h2 class="text-cyan-400 text-lg mb-4 font-bold uppercase tracking-wider text-center">Resultados</h2>
        <div class="bg-gray-800/50 rounded-lg overflow-x-auto border border-cyan-500/30 shadow-inner">
          <div id="resultsHeader" class="grid text-cyan-100 p-3 border-b border-cyan-500/20 font-bold text-xs whitespace-nowrap min-w-max uppercase tracking-wider grid-cols-4 gap-3">
            <div class="min-w-16 text-center">CASA</div>
            <div class="min-w-16 text-center">ODD</div>
            <div class="min-w-20 text-center">STAKE</div>
            <div class="min-w-20 text-center">LUCRO</div>
          </div>
          <div id="resultsRows"></div>
        </div>
      </div>
    `;
  }

  function initialRender() {
    const app = $("#app");
    app.innerHTML = `${renderTop()}${renderHouses()}${renderResultsShell()}`;

    // Eventos gerais
    $("#numHouses").addEventListener("change", (e) => {
      numHouses = parseInt(e.target.value, 10);
      $("#houses").outerHTML = renderHouses();
      attachHouseEvents();
      recalcAndUpdate();
    });
    $("#rounding").addEventListener("change", (e) => {
      displayRounding = e.target.value;
      roundingValue = parseFloat(displayRounding.replace(',', '.'));
      recalcStakeDistribution(-1);
      recalcAndUpdate();
    });

    attachHouseEvents();
    recalcAndUpdate();
  }

  function attachHouseEvents() {
    const grid = $("#houses");

    // Máscara permissiva para vírgula e ponto
    grid.querySelectorAll('input[inputmode="decimal"]').forEach((el) => {
      el.addEventListener('input', (e) => {
        const caret = el.selectionStart;
        const before = el.value;
        el.value = keepNumeric(before);
        try { el.setSelectionRange(caret, caret); } catch {}
      });
      el.addEventListener('blur', (e) => {
        const val = parseFlex(el.value);
        if (Number.isFinite(val)) el.value = fmtDec(val);
      });
    });

    // Delegação principal
    grid.querySelectorAll("[data-action]").forEach(el => {
      const action = el.getAttribute("data-action");
      const idx = parseInt(el.getAttribute("data-idx"), 10);

      if (action === "odd") {
        el.addEventListener("input", (e) => setHouse(idx, { odd: e.target.value }, ["odd"]));
      } else if (action === "stake") {
        el.addEventListener("input", (e) => setHouse(idx, { stake: e.target.value }, ["stake"]));
      } else if (action === "responsibility") {
        el.addEventListener("input", (e) => setHouse(idx, { responsibility: e.target.value }, ["responsibility"]));
      } else if (action === "toggleLay") {
        el.addEventListener("click", () => setHouse(idx, { lay: !houses[idx].lay }));
      } else if (action === "toggleCommission") {
        el.addEventListener("change", (e) => setHouse(idx, { commission: e.target.checked ? 0 : null }, ["commission"]));
      } else if (action === "commissionValue") {
        el.addEventListener("input", (e) => {
          const val = parseFlex(e.target.value);
          if (Number.isFinite(val)) setHouse(idx, { commission: val }, ["commission"]);
          else if (e.target.value === "") setHouse(idx, { commission: 0 }, ["commission"]);
        });
        el.addEventListener("blur", (e) => {
          const val = parseFlex(e.target.value);
          if (Number.isFinite(val)) e.target.value = val.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
          if (e.target.value === "") setHouse(idx, { commission: 0 }, ["commission"]);
        });
      } else if (action === "toggleFreebet") {
        el.addEventListener("change", (e) => setHouse(idx, { freebet: e.target.checked }));
      } else if (action === "fixStake") {
        el.addEventListener("click", () => fixStake(idx));
      }
    });
  }

  // Boot
  initialRender();
})();
</script>

</body>
</html>
